---
title: "Medicare Advantage Data"
author: "Ian McCarthy | Emory University"
format: 
  revealjs:
    theme: [moon]
    preview-links: auto
    chalkboard:
      boardmarker-width: 5
    slide-number: true
    width: 1600
    height: 900    
#    embed-resources: true
from: markdown+emoji
execute: 
  echo: true
---

```{r}
#| include: false
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, ggplot2, lubridate, gapminder, scales,
               hrbrthemes, gganimate, OECD, here, modelsummary)
```


## Outline for Today

Recall the Medicare Advantage repository, [Medicare Advantage GitHub repository](https://github.com/imccart/Medicare-Advantage)

1. Understand data and code structure
2. Import files using purrr (in R), or just pandas in python
3. Manage (merge and clean) data
4. Create new variables

# MA Repository

## Data structure

Let's first look through the raw data on our class OneDrive folder:

- Enrollment and contract files
- Service area files
- Plan characteristics
- Penetration files

## Code structure

Now let's turn to the code structure:

- Everything called from main code file. Easy to follow and replicate
- 

# Importing Data

## Monthly enrollment and contract info

- We follow the same structure as the full `plan_data` code:  
  1. Define a list of months.  
  2. Write typed readers for **contract** and **enrollment**.  
  3. Write a one-month loader that merges contract + enrollment.  
  4. Use `map_dfr()` to stack months into a monthly panel.

::: {.panel-tabset}

### R

```{r}
#| eval: false
library(tidyverse)
library(purrr)

# GA snippets for January–March
monthlist <- sprintf("%02d", 1:3)

# Base directory for GA snippet files
base_dir <- "data/output/ma-snippets"

# Readers (quiet & typed) -----------------------------------------------

read_contract <- function(path) {
  read_csv(
    path,
    skip = 0,   # snippets no longer have the original header row
    col_types = cols(
      contractid         = col_character(),
      planid             = col_double(),
      org_type           = col_character(),
      plan_type          = col_character(),
      partd              = col_character(),
      snp                = col_character(),
      eghp               = col_character(),
      org_name           = col_character(),
      org_marketing_name = col_character(),
      plan_name          = col_character(),
      parent_org         = col_character(),
      contract_date      = col_character()
    ),
    show_col_types = FALSE,
    progress = FALSE
  )
}

read_enroll <- function(path) {
  read_csv(
    path,
    skip = 0,
    col_types = cols(
      contractid = col_character(),
      planid     = col_double(),
      ssa        = col_double(),
      fips       = col_double(),
      state      = col_character(),
      county     = col_character(),
      enrollment = col_double()
    ),
    na = "*",
    show_col_types = FALSE,
    progress = FALSE
  )
}

# One-month loader (GA snippets) ----------------------------------------

load_month_ga <- function(m, y) {
  c_path <- file.path(base_dir, paste0("ga-contract-",   y, "-", m, ".csv"))
  e_path <- file.path(base_dir, paste0("ga-enrollment-", y, "-", m, ".csv"))

  contract.info <- read_contract(c_path) %>%
    distinct(contractid, planid, .keep_all = TRUE)

  enroll.info <- read_enroll(e_path)

  contract.info %>%
    left_join(enroll.info, by = c("contractid", "planid")) %>%
    mutate(
      month = as.integer(m),
      year  = y
    )
}

# Read all months for a given year, then tidy once ----------------------

y <- 2022   # start with 2022; repeat for 2023 in the notebook

ga_plan_year <- map_dfr(
  monthlist,
  ~ load_month_ga(.x, y)
)
```

### Python

```{python}
#| eval: false
import pandas as pd
import os

monthlist = [f"{m:02d}" for m in range(1, 4)]
base_dir = "data/output/ma-snippets"

# Readers ---------------------------------------------------------------

def read_contract(path):
    df = pd.read_csv(path)
    # Columns mirror the R version: contractid, planid, org_type, plan_type, ...
    return df

def read_enroll(path):
    df = pd.read_csv(path)
    # Columns mirror the R version: contractid, planid, ssa, fips, state, county, enrollment
    return df

# One-month loader (GA snippets) ---------------------------------------

def load_month_ga(m, year):
    c_path = os.path.join(base_dir, f"ga-contract-{year}-{m}.csv")
    e_path = os.path.join(base_dir, f"ga-enrollment-{year}-{m}.csv")

    contract_info = read_contract(c_path).drop_duplicates(subset=["contractid", "planid"])
    enroll_info   = read_enroll(e_path)

    merged = contract_info.merge(
        enroll_info,
        on=["contractid", "planid"],
        how="left"
    )
    merged["month"] = int(m)
    merged["year"]  = int(year)
    return merged

# Read all months for a given year, then stack -------------------------

y = 2022  # start with 2022; repeat for 2023 in the notebook

ga_plan_year = pd.concat(
    [load_month_ga(m, y) for m in monthlist],
    ignore_index=True
)
```

:::


## Collapse to the year level

- Now mimic the `final.plans` step from the full repo:  
  - Tidy the monthly panel (sort + fill IDs and plan/org characteristics).  
  - Collapse to one row per **contract–plan–county–year** with summary enrollment stats.

::: {.panel-tabset}

### R

```{r}
#| eval: false
# Starting point: ga_plan_year (monthly GA plan data for a single year)

ga_plan_year_tidy <- ga_plan_year %>%
  arrange(contractid, planid, state, county, month) %>%
  group_by(state, county) %>%
  fill(fips, .direction = "downup") %>%
  ungroup() %>%
  group_by(contractid, planid) %>%
  fill(plan_type, partd, snp, eghp, plan_name, .direction = "downup") %>%
  ungroup() %>%
  group_by(contractid) %>%
  fill(org_type, org_name, org_marketing_name, parent_org, .direction = "downup") %>%
  ungroup()

ga_plans_year <- ga_plan_year_tidy %>%
  group_by(contractid, planid, fips, year) %>%
  arrange(month, .by_group = TRUE) %>%
  summarize(
    n_nonmiss        = sum(!is.na(enrollment)),
    avg_enrollment   = ifelse(n_nonmiss > 0, mean(enrollment, na.rm = TRUE), NA_real_),
    sd_enrollment    = ifelse(n_nonmiss > 1, sd(enrollment, na.rm = TRUE), NA_real_),
    min_enrollment   = ifelse(n_nonmiss > 0, min(enrollment, na.rm = TRUE), NA_real_),
    max_enrollment   = ifelse(n_nonmiss > 0, max(enrollment, na.rm = TRUE), NA_real_),
    first_enrollment = ifelse(n_nonmiss > 0, first(na.omit(enrollment)), NA_real_),
    last_enrollment  = ifelse(n_nonmiss > 0,  last(na.omit(enrollment)),  NA_real_),
    state            = last(state),
    county           = last(county),
    org_type         = last(org_type),
    plan_type        = last(plan_type),
    partd            = last(partd),
    snp              = last(snp),
    eghp             = last(eghp),
    org_name         = last(org_name),
    org_marketing_name = last(org_marketing_name),
    plan_name        = last(plan_name),
    parent_org       = last(parent_org),
    contract_date    = last(contract_date),
    year             = last(year),
    .groups = "drop"
  )
```

### Python

```{python}
#| eval: false
# Starting point: ga_plan_year (monthly GA plan data for a single year)

import numpy as np

# Sort and forward-fill IDs and characteristics ------------------------
ga_plan_year_sorted = (
    ga_plan_year
    .sort_values(["state", "county", "contractid", "planid", "month"])
    .copy()
)

# Fill fips within county
ga_plan_year_sorted["fips"] = (
    ga_plan_year_sorted
    .groupby(["state", "county"])["fips"]
    .ffill()
    .bfill()
)

# Fill plan-level variables within contract–plan
for col in ["plan_type", "partd", "snp", "eghp", "plan_name"]:
    ga_plan_year_sorted[col] = (
        ga_plan_year_sorted
        .groupby(["contractid", "planid"])[col]
        .ffill()
        .bfill()
    )

# Fill org-level variables within contract
for col in ["org_type", "org_name", "org_marketing_name", "parent_org"]:
    ga_plan_year_sorted[col] = (
        ga_plan_year_sorted
        .groupby("contractid")[col]
        .ffill()
        .bfill()
    )

# Helpers to get first/last non-missing enrollment ---------------------
def first_nonmissing(x):
    x = x.dropna()
    return x.iloc[0] if not x.empty else np.nan

def last_nonmissing(x):
    x = x.dropna()
    return x.iloc[-1] if not x.empty else np.nan

# Collapse to yearly panel ---------------------------------------------
ga_plans_year = (
    ga_plan_year_sorted
    .sort_values(["contractid", "planid", "fips", "year", "month"])
    .groupby(["contractid", "planid", "fips", "year"], as_index=False)
    .agg(
        n_nonmiss        = ("enrollment", lambda x: x.notna().sum()),
        avg_enrollment   = ("enrollment", "mean"),
        sd_enrollment    = ("enrollment", "std"),
        min_enrollment   = ("enrollment", "min"),
        max_enrollment   = ("enrollment", "max"),
        first_enrollment = ("enrollment", first_nonmissing),
        last_enrollment  = ("enrollment", last_nonmissing),
        state            = ("state", "last"),
        county           = ("county", "last"),
        org_type         = ("org_type", "last"),
        plan_type        = ("plan_type", "last"),
        partd            = ("partd", "last"),
        snp              = ("snp", "last"),
        eghp             = ("eghp", "last"),
        org_name         = ("org_name", "last"),
        org_marketing_name = ("org_marketing_name", "last"),
        plan_name        = ("plan_name", "last"),
        parent_org       = ("parent_org", "last"),
        contract_date    = ("contract_date", "last"),
        year_out         = ("year", "last"),
    )
    .rename(columns={"year_out": "year"})
)
```

:::

## Import and collapse service area data

- Follow the same pattern as the full `service-area` code:  
  1. Define a list of months.  
  2. Write a typed reader for **service area**.  
  3. Write a one-month loader.  
  4. Use `map_dfr()` to stack months and then collapse to a yearly panel.  
- Here we work directly with the **GA service-area snippets** (`ga-service-area-YYYY-MM.csv`).

::: {.panel-tabset}

### R

```{r}
#| eval: false
library(tidyverse)
library(purrr)

# GA snippets for January–March
monthlist <- sprintf("%02d", 1:3)

base_dir_sa <- "data/output/ma-snippets"

# Reader for GA service-area snippets -----------------------------------

read_service_area_ga <- function(path) {
  read_csv(
    path,
    skip = 0,   # snippets already have clean headers
    col_types = cols(
      contractid = col_character(),
      org_name   = col_character(),
      org_type   = col_character(),
      plan_type  = col_character(),
      partial    = col_logical(),
      eghp       = col_character(),
      ssa        = col_double(),
      fips       = col_double(),
      county     = col_character(),
      state      = col_character(),
      notes      = col_character()
    ),
    na = "*",
    show_col_types = FALSE,
    progress = FALSE
  )
}

# One-month loader (GA service area) -----------------------------------

load_month_sa_ga <- function(m, y) {
  path <- file.path(base_dir_sa, paste0("ga-service-area-", y, "-", m, ".csv"))

  read_service_area_ga(path) %>%
    mutate(
      month = as.integer(m),
      year  = y
    )
}

# Read all months for a given year, then tidy once ---------------------

y <- 2022   # start with 2022; repeat for 2023 in the notebook

service_year_ga <- map_dfr(
  monthlist,
  ~ load_month_sa_ga(.x, y)
)

# Ensure stable order before fills
service_year_ga <- service_year_ga %>%
  arrange(contractid, fips, state, county, month)

# Fill missing identifiers / labels
service_year_ga <- service_year_ga %>%
  group_by(state, county) %>%
  fill(fips, .direction = "downup") %>%
  ungroup() %>%
  group_by(contractid) %>%
  fill(plan_type, partial, eghp, org_type, org_name, .direction = "downup") %>%
  ungroup()

# Collapse to yearly: one row per contract × county (fips) × year ------

ga_service_year <- service_year_ga %>%
  group_by(contractid, fips, year) %>%
  arrange(month, .by_group = TRUE) %>%
  summarize(
    state     = last(state),
    county    = last(county),
    org_name  = last(org_name),
    org_type  = last(org_type),
    plan_type = last(plan_type),
    partial   = last(partial),
    eghp      = last(eghp),
    ssa       = last(ssa),
    notes     = last(notes),
    .groups   = "drop"
  )
```

### Python

```{python}
#| eval: false
import pandas as pd
import numpy as np
import os

monthlist = [f"{m:02d}" for m in range(1, 4)]
base_dir_sa = "data/output/ma-snippets"

# Reader for GA service-area snippets ----------------------------------

def read_service_area_ga(path):
    df = pd.read_csv(path)
    # Expected columns:
    # contractid, org_name, org_type, plan_type, partial, eghp,
    # ssa, fips, county, state, notes
    return df

# One-month loader (GA service area) -----------------------------------

def load_month_sa_ga(m, year):
    path = os.path.join(base_dir_sa, f"ga-service-area-{year}-{m}.csv")
    df = read_service_area_ga(path)
    df["month"] = int(m)
    df["year"] = int(year)
    return df

# Read all months for a given year, then stack -------------------------

y = 2022  # start with 2022; repeat for 2023 in the notebook

service_year_ga = pd.concat(
    [load_month_sa_ga(m, y) for m in monthlist],
    ignore_index=True
)

# Ensure stable order before fills
service_year_ga = service_year_ga.sort_values(
    ["contractid", "fips", "state", "county", "month"]
)

# Fill missing identifiers / labels ------------------------------------

# Fill fips within state–county
service_year_ga["fips"] = (
    service_year_ga
    .groupby(["state", "county"])["fips"]
    .ffill()
    .bfill()
)

# Fill contract-level info within contractid
for col in ["plan_type", "partial", "eghp", "org_type", "org_name"]:
    service_year_ga[col] = (
        service_year_ga
        .groupby("contractid")[col]
        .ffill()
        .bfill()
    )

# Collapse to yearly: one row per contract × county (fips) × year ------

ga_service_year = (
    service_year_ga
    .sort_values(["contractid", "fips", "year", "month"])
    .groupby(["contractid", "fips", "year"], as_index=False)
    .agg(
        state     = ("state", "last"),
        county    = ("county", "last"),
        org_name  = ("org_name", "last"),
        org_type  = ("org_type", "last"),
        plan_type = ("plan_type", "last"),
        partial   = ("partial", "last"),
        eghp      = ("eghp", "last"),
        ssa       = ("ssa", "last"),
        notes     = ("notes", "last"),
    )
)
```

:::

## Characteristics and penetration files

- In the full repo, `3_plan-characteristics-YYYY.R` and `4_penetration.R` build **yearly** plan-characteristics (`final.landscape`) and penetration (`final.penetration`) files.
- Here we start from the corresponding **GA snippets** that were already created from those yearly files:
  - `ga-landscape-2022.csv`
  - `ga-penetration-2022.csv`

::: {.panel-tabset}

### R

```{r}
#| eval: false
library(tidyverse)

y <- 2022
base_dir <- "data/output/ma-snippets"

# GA plan characteristics (landscape) -----------------------------------

ga_landscape <- read_csv(
  file.path(base_dir, paste0("ga-landscape-", y, ".csv")),
  show_col_types = FALSE
)

# GA penetration data ---------------------------------------------------

ga_penetration <- read_csv(
  file.path(base_dir, paste0("ga-penetration-", y, ".csv")),
  show_col_types = FALSE
)

# These are already yearly GA files, analogous to final.landscape and final.penetration
# in the full Medicare-Advantage repo.
```

### Python

```{python}
#| eval: false
import pandas as pd
import os

y = 2022
base_dir = "data/output/ma-snippets"

# GA plan characteristics (landscape) ----------------------------------

ga_landscape = pd.read_csv(
    os.path.join(base_dir, f"ga-landscape-{y}.csv")
)

# GA penetration data --------------------------------------------------

ga_penetration = pd.read_csv(
    os.path.join(base_dir, f"ga-penetration-{y}.csv")
)

# These are already yearly GA files, analogous to the R objects
# final.landscape and final.penetration in the full repo.
```

:::

# Managing the data

## Merging everything together

- Now mirror the `final.ma` construction from the full repo, but focusing on GA and 2022 only.
- Starting objects (all for 2022):  
  - `ga_plans_year` – yearly GA plan panel (from contracts + enrollment).  
  - `ga_service_year` – yearly GA service-area panel.  
  - `ga_landscape` – GA plan characteristics (landscape, incl. `premium_partc`).  
  - `ga_penetration` – GA penetration data.

---

::: {.panel-tabset}

### R

```{r}
#| eval: false
# 1. Merge plans and service areas (contract × fips × year) --------------

ga_ma_2022 <- ga_plans_year %>%
  inner_join(
    ga_service_year %>%
      select(contractid, fips, state, county, year),
    by = c("contractid", "fips", "year")
  ) %>%
  # 2. Apply basic filters, similar to full repo
  filter(
    state == "GA",
    snp == "No",
    (planid < 800 | planid >= 900),
    !is.na(planid),
    !is.na(fips)
  )

# 3. Merge penetration data (by county FIPS and year) -------------------

ga_ma_2022 <- ga_ma_2022 %>%
  left_join(
    ga_penetration,
    by = c("fips", "year")
  )

# 4. Merge plan characteristics / premiums (landscape) ------------------

ga_ma_2022 <- ga_ma_2022 %>%
  left_join(
    ga_landscape,
    by = c("contractid", "planid", "county", "year")
  )

# ga_ma_2022 is now a GA plan–county–year dataset with enrollment,
# service area, penetration, and premium_partc information for 2022.
```

### Python

```{python}
#| eval: false
# 1. Merge plans and service areas (contract × fips × year) --------------

ga_ma_2022 = (
    ga_plans_year
    .merge(
        ga_service_year[["contractid", "fips", "state", "county", "year"]],
        on=["contractid", "fips", "year"],
        how="inner"
    )
)

# 2. Apply basic filters, similar to full repo ---------------------------

ga_ma_2022 = ga_ma_2022[
    (ga_ma_2022["state"] == "GA")
    & (ga_ma_2022["snp"] == "No")
    & ((ga_ma_2022["planid"] < 800) | (ga_ma_2022["planid"] >= 900))
    & ga_ma_2022["planid"].notna()
    & ga_ma_2022["fips"].notna()
].copy()

# 3. Merge penetration data (by county FIPS and year) -------------------

ga_ma_2022 = ga_ma_2022.merge(
    ga_penetration,
    on=["fips", "year"],
    how="left"
)

# 4. Merge plan characteristics / premiums (landscape) ------------------

ga_ma_2022 = ga_ma_2022.merge(
    ga_landscape,
    on=["contractid", "planid", "county", "year"],
    how="left"
)

# ga_ma_2022 is now a GA plan–county–year dataset with enrollment,
# service area, penetration, and premium_partc information for 2022.
```

:::


## Final preparation for county-level analysis

- `ga_ma_2022` is at the **plan–county–year** level (with `avg_enrollment`, `premium_partc`, `avg_eligibles`, etc.).  
- To study how **competition** relates to **premiums**, we move to the **county–year** level and construct county-year level measures of premiums and competition

---

::: {.panel-tabset}

### R

```{r}
#| eval: false
library(tidyverse)

# Step 1: compute market shares within each county-year ------------------
# total_ma_enrollment and avg_eligibles come from the penetration file:
#   avg_enrolled = total MA enrollment in the county
#   avg_eligibles = total Medicare beneficiaries

ga_ma_2022_shares <- ga_ma_2022 %>%
  group_by(fips, county, year) %>%
  mutate(
    total_ma_enrollment = first(avg_enrolled),
    ma_share = if_else(
      total_ma_enrollment > 0,
      avg_enrollment / total_ma_enrollment,
      NA_real_
    )
  ) %>%
  ungroup()

# Step 2: collapse to county-year level ---------------------------------

ga_county_2022 <- ga_ma_2022_shares %>%
  group_by(fips, county, year) %>%
  summarize(
    # Competition: HHI = sum of squared MA shares
    hhi_ma = sum(ma_share^2, na.rm = TRUE),

    # Prices: simple average of Part C premiums across plans in the county
    avg_premium_partc = mean(premium_partc, na.rm = TRUE),

    # Count of plans with positive premium
    n_pos_premiums = sum(premium_partc > 0, na.rm = TRUE),

    # Premium range: max - min within county-year
    premium_range = ifelse(
      all(is.na(premium_partc)),
      NA_real_,
      max(premium_partc, na.rm = TRUE) - min(premium_partc, na.rm = TRUE)
    ),

    # Total MA enrollment in the county (from penetration)
    total_ma_enrollment = first(avg_enrolled),

    # Total Medicare eligibles (from penetration)
    avg_eligibles = first(avg_eligibles),

    .groups = "drop"
  )
```

### Python

```{python}
#| eval: false
import numpy as np
import pandas as pd

# Step 1: compute market shares within each county-year ------------------
# total_ma_enrollment and avg_eligibles come from the penetration file:
#   avg_enrolled = total MA enrollment in the county
#   avg_eligibles = total Medicare beneficiaries

def add_shares(df):
    total_ma = df["avg_enrolled"].iloc[0]
    df = df.copy()
    df["total_ma_enrollment"] = total_ma
    df["ma_share"] = np.where(
        total_ma > 0,
        df["avg_enrollment"] / total_ma,
        np.nan
    )
    return df

ga_ma_2022_shares = (
    ga_ma_2022
    .groupby(["fips", "county", "year"], group_keys=False)
    .apply(add_shares)
)

# Step 2: collapse to county-year level ---------------------------------

ga_county_2022 = (
    ga_ma_2022_shares
    .groupby(["fips", "county", "year"], as_index=False)
    .agg(
        # HHI on MA shares
        hhi_ma=("ma_share", lambda x: np.nansum(x**2)),

        # Average premium
        avg_premium_partc=("premium_partc", "mean"),

        # Count of plans with positive premium
        n_pos_premiums=("premium_partc", lambda x: (x > 0).sum()),

        # Premium range: max - min
        premium_range=("premium_partc", lambda x: x.max() - x.min()),

        # Total MA enrollment (from penetration)
        total_ma_enrollment=("avg_enrolled", "first"),

        # Total Medicare eligibles (from penetration)
        avg_eligibles=("avg_eligibles", "first"),
    )
)
```

:::


## New variables

- **Total MA enrollment**: $\sum_j \text{avg_enrollment}_{j,cy}$
- MA plan **market shares**: $$s_{j,cy} = \frac{\text{avg_enrollment}_{j,cy}}{\text{avg_enrolled}_{cy}}$$, where `avg_enrolled` comes from the **penetration** file and represents total MA enrollment in the county.  
- **HHI**: $\sum_j s_{j,cy}^2$.
- **Average premium**: mean of `premium_partc` across plans in the county.  
- **Total eligibles**: `avg_eligibles` from penetration data.  
- **Count of positive premiums**: number of plans with `premium_partc > 0`.  
- **Premium range**: $\max(\text{premium_partc}) - \min(\text{premium_partc})$ within county–year.


## Plot premium and hhi

- As a simple descriptive exercise, we can **plot average MA premiums against market concentration** (HHI) at the county–year level.  
- This doesn’t establish causality; it just helps visualize how **more concentrated markets (higher HHI)** line up with **average premiums** in our GA sample.

::: {.panel-tabset}

### R

```{r}
#| eval: false
library(ggplot2)

ggplot(ga_county_2022, aes(x = hhi_ma, y = avg_premium_partc)) +
  geom_point() +
  labs(
    x = "MA market concentration (HHI)",
    y = "Average Part C premium",
    title = "County-level MA premiums and competition in Georgia, 2022"
  )
```

### Python

```{python}
#| eval: false
import matplotlib.pyplot as plt

plt.scatter(ga_county_2022["hhi_ma"], ga_county_2022["avg_premium_partc"])
plt.xlabel("MA market concentration (HHI)")
plt.ylabel("Average Part C premium")
plt.title("County-level MA premiums and competition in Georgia, 2022")
plt.show()
```

:::
